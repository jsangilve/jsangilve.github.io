<!DOCTYPE html>
<html lang="en">
  <head>
            <title>HATE THAT CODE</title>
          <meta charset="utf-8" />
          <!-- Mobile Specific Metas
          –––––––––––––––––––––––––––––––––––––––––––––––––– -->
          <meta name="viewport" content="width=device-width, initial-scale=1">
          <!-- Roboto -->
          <link href='https://fonts.googleapis.com/css?family=Roboto:400,300' rel='stylesheet' type='text/css'>
          <link href='https://fonts.googleapis.com/css?family=Roboto+Condensed:300' rel='stylesheet' type='text/css'>
          <!--Skeleton CSS
          –––––––––––––––––––––––––––––––––––––––––––––––––– -->
          <link rel="stylesheet" href="/theme/css/pure-min.css">
          <!--Custom CSS-->
          <link rel="stylesheet" href="/theme/css/custom.css">
          <link rel="stylesheet" href="/theme/css/pygment.css">
          <!-- Favicon
          –––––––––––––––––––––––––––––––––––––––––––––––––– -->
          <link rel="icon" type="image/png" href="/theme/images/favicon.png" />




    <meta name="tags" contents="elixir" />
    <meta name="tags" contents="ecto" />
    <meta name="tags" contents="jsonb" />
    <meta name="tags" contents="postgresql" />

  </head>
  <body id="index" class="home">
            <div class="container pure-g">
                  <div class="pure-u-1 pure-u-sm-1-12">
                  <header id="banner" class="blog-title">
                    <h1><img src="/theme/images/angry_logo_75.png" /><a href="/">HATE THAT CODE</a></h1>
                      <h2>by josé san gil</h2>
                  </header><!-- /#banner -->
                  <nav id="menu">
                    <ul>
                    </ul>
                  </nav><!-- /#menu -->
<section id="content" class="body article">
  <header>
    <abbr class="published" title="2019-01-08T00:00:00+01:00"> Tue 08 January 2019 </abbr>
    <h2 class="entry-title">
      <a href="/a-macro-to-query-over-multiple-fields-of-a-jsonb-column.html" rel="bookmark"
         title="Permalink to A macro to query over multiple fields of a JSONB column">A macro to query over multiple fields of a JSONB column</a></h2>
 
  </header>
  <footer class="post-info">
  </footer><!-- /.post-info -->
  <div class="entry-content">
    <p>When working with an <code>Ecto.Schema</code> that contains a JSONB column, you normally create a <a href="https://hexdocs.pm/ecto/Ecto.Query.API.html#fragment/1" target="&quot;_blank">fragment</a> to query the attributes of a column.</p>
<p>For instance, let's assume we have the following schema:</p>
<div class="highlight"><pre><span></span><code> <span class="kd">defmodule</span> <span class="nc">Vehicle</span> <span class="k">do</span>
   <span class="na">@primary_key</span> <span class="p">{</span><span class="ss">:id</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">autogenerate</span><span class="p">:</span> <span class="no">true</span><span class="p">}</span>
   <span class="n">schema</span> <span class="s2">&quot;vehicle&quot;</span> <span class="k">do</span>
     <span class="n">field</span> <span class="ss">:brand</span><span class="p">,</span> <span class="ss">:string</span>
     <span class="n">field</span> <span class="ss">:model</span><span class="p">,</span> <span class="ss">:string</span>
     <span class="n">field</span> <span class="ss">:specs</span><span class="p">,</span> <span class="ss">:map</span>
   <span class="k">end</span>
 <span class="k">end</span>
</code></pre></div>


<p>The field <code>specs</code> is a Postgres' <code>jsonb</code> column storing vehicle's information as engine type, horsepower, dimensions, passenger capacity, etc. Let's imagine we decided to use <code>jsonb</code> because specs between vehicles can be significantly different i.e. some <code>jsonb</code> attributes of a vehicle might not exist for another model.</p>
<h2>Queries</h2>
<p>If we want to get all the vehicles which brand is Mercedes-Benz and passenger capacity is 5, we would write something like this:</p>
<div class="highlight"><pre><span></span><code> <span class="c1"># using jsonb containment operator</span>
 <span class="kd">def</span> <span class="n">query_by_brand_capacity</span><span class="p">(</span><span class="n">brand</span><span class="p">,</span> <span class="n">capacity</span><span class="p">)</span> <span class="k">do</span>
   <span class="nc">Vehicle</span>
   <span class="o">|&gt;</span> <span class="n">where</span><span class="p">([</span><span class="n">v</span><span class="p">],</span> <span class="n">v</span><span class="o">.</span><span class="n">brand</span> <span class="o">==</span> <span class="o">^</span><span class="n">brand</span><span class="p">)</span>
   <span class="o">|&gt;</span> <span class="n">where</span><span class="p">([</span><span class="n">v</span><span class="p">],</span> <span class="n">fragment</span><span class="p">(</span>
     <span class="s2">&quot;specs @&gt; ?::jsonb&quot;</span><span class="p">,</span> 
     <span class="o">^</span><span class="p">%{</span><span class="s2">&quot;passenger_capacity&quot;</span> <span class="o">=&gt;</span> <span class="n">capacity</span><span class="p">}</span>
   <span class="p">))</span>
 <span class="k">end</span>

 <span class="c1"># or we could also write it using the object field operator</span>
 <span class="kd">def</span> <span class="n">query_by_brand_capacity_v2</span><span class="p">(</span><span class="n">brand</span><span class="p">,</span> <span class="n">capacity</span><span class="p">)</span> <span class="k">do</span>
   <span class="nc">Vehicle</span>
   <span class="o">|&gt;</span> <span class="n">where</span><span class="p">([</span><span class="n">v</span><span class="p">],</span> <span class="n">v</span><span class="o">.</span><span class="n">brand</span> <span class="o">==</span> <span class="o">^</span><span class="n">brand</span><span class="p">)</span>
   <span class="o">|&gt;</span> <span class="n">where</span><span class="p">([</span><span class="n">v</span><span class="p">],</span> <span class="n">fragment</span><span class="p">(</span><span class="s2">&quot;(specs -&gt; &#39;passenger_capacity&#39;) = ?&quot;</span><span class="p">,</span> <span class="o">^</span><span class="n">capacity</span><span class="p">))</span>
 <span class="k">end</span>

 <span class="c1"># we could use this queries as follows</span>
 <span class="n">iex</span><span class="o">&gt;</span> <span class="n">query_by_brand_capacity</span><span class="p">(</span><span class="s2">&quot;Mercedes-Benz&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="nc">Repo</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
 <span class="p">[</span>
   <span class="p">%</span><span class="nc">JsonbMacroExample.Schemas.Vehicle</span><span class="p">{</span>
     <span class="ss">__meta__</span><span class="p">:</span> <span class="c1">#Ecto.Schema.Metadata&lt;:loaded, &quot;vehicle&quot;&gt;,</span>
     <span class="ss">brand</span><span class="p">:</span> <span class="s2">&quot;Mercedes-Benz&quot;</span><span class="p">,</span>
     <span class="ss">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
     <span class="ss">model</span><span class="p">:</span> <span class="s2">&quot;E Class&quot;</span><span class="p">,</span>
     <span class="ss">specs</span><span class="p">:</span> <span class="p">%{</span><span class="s2">&quot;passenger_capacity&quot;</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="n">...</span><span class="p">}</span>
   <span class="p">}</span>
 <span class="p">]</span>
</code></pre></div>


<p>This is a fairly simple query, but it's restricted to the <code>passenger_capacity</code> field. If we want to query other <code>jsonb</code> fields — or vehicle's specs — we need to add them to the query function or create a new one. This doesn't scale; We don't know all the possible vehicle's specs in advance.</p>
<h2>A Macro</h2>
<p>Let's say we want to have all the vehicles which <code>passenger_capacity</code> is <code>x</code>, <code>engine_type</code> is <code>e_type</code>, and <code>drive_type</code> is <code>d_type</code>.</p>
<p>Following the previous approach, we would define the following query:</p>
<div class="highlight"><pre><span></span><code> <span class="kd">def</span> <span class="n">query_by_engine_capacity_drive</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">capacity</span><span class="p">,</span> <span class="n">drive</span><span class="p">)</span> <span class="k">do</span>
   <span class="nc">Vehicle</span>
   <span class="o">|&gt;</span> <span class="n">where</span><span class="p">([</span><span class="n">_v</span><span class="p">],</span> <span class="n">fragment</span><span class="p">(</span>
     <span class="s2">&quot;specs @&gt; ? AND specs @&gt; ? AND specs @&gt; ?&quot;</span><span class="p">,</span>
     <span class="o">^</span><span class="p">%{</span><span class="s2">&quot;engine_type&quot;</span> <span class="o">=&gt;</span> <span class="n">engine</span><span class="p">},</span>
     <span class="o">^</span><span class="p">%{</span><span class="s2">&quot;passenger_capacity&quot;</span> <span class="o">=&gt;</span> <span class="n">capacity</span><span class="p">},</span>
     <span class="o">^</span><span class="p">%{</span><span class="s2">&quot;drive_type&quot;</span> <span class="o">=&gt;</span> <span class="n">drive</span><span class="p">}</span>
   <span class="p">))</span>
 <span class="k">end</span>
</code></pre></div>


<p>The ideal API would provide a function where multiple <code>jsonb</code> fields can be query and combined at the same time using <code>AND</code> / <code>OR</code> operators:</p>
<div class="highlight"><pre><span></span><code> <span class="n">iex</span><span class="o">&gt;</span> <span class="n">query_specs</span><span class="p">(</span>
   <span class="n">query</span><span class="p">,</span> 
   <span class="ss">engine_type</span><span class="p">:</span> <span class="s2">&quot;Electric&quot;</span><span class="p">,</span> <span class="ss">passenger_capacity</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="ss">drive_type</span><span class="p">:</span> <span class="s2">&quot;Front Wheel&quot;</span>
 <span class="p">)</span> <span class="o">|&gt;</span> <span class="nc">Repo</span><span class="o">.</span><span class="n">all</span>
 <span class="p">[</span>
   <span class="p">%</span><span class="nc">JsonbMacroExample.Schemas.Vehicle</span><span class="p">{</span>
     <span class="ss">__meta__</span><span class="p">:</span> <span class="c1">#Ecto.Schema.Metadata&lt;:loaded, &quot;vehicle&quot;&gt;,</span>
     <span class="ss">brand</span><span class="p">:</span> <span class="s2">&quot;Mercedes-Benz&quot;</span><span class="p">,</span>
     <span class="ss">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
     <span class="ss">model</span><span class="p">:</span> <span class="s2">&quot;E Class&quot;</span><span class="p">,</span>
     <span class="ss">specs</span><span class="p">:</span> <span class="p">%{</span>
       <span class="s2">&quot;passenger_capacity&quot;</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">,</span> 
       <span class="s2">&quot;engine_type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Electric&quot;</span><span class="p">,</span> 
       <span class="s2">&quot;drive_type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Front Wheel&quot;</span>
     <span class="p">}</span>
   <span class="p">}</span>
   <span class="n">...</span>
 <span class="p">]</span>
</code></pre></div>


<p>Let's try to define a macro that does that:</p>
<div class="highlight"><pre><span></span><code> <span class="kd">defmacro</span> <span class="n">json_multi_expressions_v0</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span> <span class="k">do</span>
   <span class="c1"># conjuctive operator to be used between fragments</span>
   <span class="n">conjuntion</span> <span class="o">=</span> <span class="nc">Keyword</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="ss">:conjuntion</span><span class="p">,</span> <span class="ss">:and</span><span class="p">)</span>

   <span class="k">quote</span> <span class="k">do</span>
     <span class="n">fragments</span> <span class="o">=</span>
       <span class="nc">Enum</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="k">unquote</span><span class="p">(</span><span class="n">params</span><span class="p">),</span> <span class="no">nil</span><span class="p">,</span> <span class="k">fn</span> <span class="p">{</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">},</span> <span class="n">acc</span> <span class="o">-&gt;</span>
                <span class="c1"># create a fragment and wrap it within a Ecto&#39;s dynamic</span>
              <span class="c1"># expression that could be joined (nested).</span>
         <span class="n">frag</span> <span class="o">=</span>
           <span class="n">dynamic</span><span class="p">(</span>
             <span class="p">[</span><span class="n">q</span><span class="p">],</span>
             <span class="n">fragment</span><span class="p">(</span>
               <span class="s2">&quot;?::jsonb @&gt; ?::jsonb&quot;</span><span class="p">,</span>
               <span class="n">field</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="o">^</span><span class="k">unquote</span><span class="p">(</span><span class="n">col</span><span class="p">)),</span>
               <span class="o">^</span><span class="p">%{</span><span class="n">to_string</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">val</span><span class="p">}</span>
             <span class="p">)</span>
           <span class="p">)</span>

         <span class="nc">JsonbMacroExample</span><span class="o">.</span><span class="n">do_combine</span><span class="p">(</span><span class="n">frag</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="k">unquote</span><span class="p">(</span><span class="n">conjunction</span><span class="p">))</span>
       <span class="k">end</span><span class="p">)</span>
   <span class="k">end</span>
 <span class="k">end</span>

 <span class="kd">def</span> <span class="n">do_combine</span><span class="p">(</span><span class="n">frag</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">conjunction</span><span class="p">)</span>
 <span class="kd">def</span> <span class="n">do_combine</span><span class="p">(</span><span class="n">frag</span><span class="p">,</span> <span class="no">nil</span><span class="p">,</span> <span class="bp">_</span><span class="p">),</span> <span class="ss">do</span><span class="p">:</span> <span class="n">frag</span>
 <span class="kd">def</span> <span class="n">do_combine</span><span class="p">(</span><span class="n">frag</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="ss">:or</span><span class="p">),</span> <span class="ss">do</span><span class="p">:</span> <span class="n">dynamic</span><span class="p">([</span><span class="n">q</span><span class="p">],</span> <span class="o">^</span><span class="n">acc</span> <span class="ow">or</span> <span class="o">^</span><span class="n">frag</span><span class="p">)</span>
 <span class="kd">def</span> <span class="n">do_combine</span><span class="p">(</span><span class="n">frag</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="bp">_</span><span class="p">),</span> <span class="ss">do</span><span class="p">:</span> <span class="n">dynamic</span><span class="p">([</span><span class="n">q</span><span class="p">],</span> <span class="o">^</span><span class="n">acc</span> <span class="ow">and</span> <span class="o">^</span><span class="n">frag</span><span class="p">)</span>
</code></pre></div>


<p>The <code>macro</code> above compares each JSONB field in <code>params</code>, and combines it (via reduce) on dynamic expressions joined by <code>:or</code> or <code>:and</code> (depending on the <code>conjuction</code> option).</p>
<p>Using the macro above we're now able to write <code>query_specs/3</code>:</p>
<div class="highlight"><pre><span></span><code> <span class="na">@spec</span> <span class="n">query_specs</span><span class="p">(</span><span class="nc">Ecto.Query</span><span class="o">.</span><span class="n">t</span><span class="p">(),</span> <span class="nc">Keyword</span><span class="o">.</span><span class="n">t</span><span class="p">())</span> <span class="o">::</span> <span class="p">[</span><span class="n">vehicle</span><span class="p">]</span>
 <span class="kd">def</span> <span class="n">query_specs</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">conjunction</span> <span class="o">//</span> <span class="ss">:and</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">query</span>
    <span class="o">|&gt;</span> <span class="n">where</span><span class="p">(</span>
    <span class="p">[</span><span class="n">_q</span><span class="p">],</span> 
    <span class="o">^</span><span class="n">json_multi_expressions_v0</span><span class="p">(</span><span class="ss">:specs</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="p">[</span><span class="ss">conjunction</span><span class="p">:</span> <span class="n">conjunction</span><span class="p">])</span>
  <span class="p">)</span>
 <span class="k">end</span>
</code></pre></div>


<p>This works reasonably well, and allows to query as many Vehicle <code>specs</code> as necessary without having to write a new query. However, what if some <code>jsonb</code> fields require a more complex comparison?</p>
<p>Imagine we need to query for vehicles which <code>passenger_capacity</code> is <strong>greater or equal than</strong> <code>x</code>, <code>engine_type</code> is <code>e_type</code>, and <code>drive_type</code> is <code>d_type</code>. The macro above won't be enough to do this. Let's get back to the macro's implementation and introduce a new option.</p>
<p>First, let's make the macro more readable:</p>
<div class="highlight"><pre><span></span><code> <span class="kd">defmacro</span> <span class="n">json_multi_expressions_v1</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span> <span class="k">do</span>
   <span class="c1"># conjuctive operator to be used between fragments</span>
   <span class="n">conjunction</span> <span class="o">=</span> <span class="nc">Keyword</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="ss">:conjunction</span><span class="p">,</span> <span class="ss">:and</span><span class="p">)</span>

   <span class="k">quote</span> <span class="k">do</span>
     <span class="nc">JsonbMacroExample</span><span class="o">.</span><span class="n">build_fragments</span><span class="p">(</span>
       <span class="k">unquote</span><span class="p">(</span><span class="n">params</span><span class="p">),</span>
       <span class="k">unquote</span><span class="p">(</span><span class="n">col</span><span class="p">),</span>
       <span class="k">unquote</span><span class="p">(</span><span class="n">conjunction</span><span class="p">)</span>
     <span class="p">)</span>
   <span class="k">end</span>
 <span class="k">end</span>

 <span class="na">@doc</span> <span class="no">false</span>
 <span class="na">@spec</span> <span class="n">build_expressions</span><span class="p">(</span><span class="n">map</span><span class="p">()</span> <span class="o">|</span> <span class="nc">Keyword</span><span class="o">.</span><span class="n">t</span><span class="p">(),</span> <span class="n">atom</span><span class="p">(),</span> <span class="n">atom</span><span class="p">())</span> <span class="o">::</span> <span class="nc">Macro</span><span class="o">.</span><span class="n">t</span><span class="p">()</span>
 <span class="kd">def</span> <span class="n">build_expressions</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">conjunction</span><span class="p">)</span> <span class="k">do</span>
   <span class="nc">Enum</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="no">nil</span><span class="p">,</span> <span class="k">fn</span> <span class="p">{</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">},</span> <span class="n">acc</span> <span class="o">-&gt;</span>
     <span class="n">frag</span> <span class="o">=</span>
       <span class="n">dynamic</span><span class="p">(</span>
         <span class="p">[</span><span class="n">q</span><span class="p">],</span>
         <span class="n">fragment</span><span class="p">(</span>
           <span class="s2">&quot;?::jsonb @&gt; ?::jsonb&quot;</span><span class="p">,</span>
           <span class="n">field</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="o">^</span><span class="n">col</span><span class="p">),</span>
           <span class="o">^</span><span class="p">%{</span><span class="n">to_string</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">val</span><span class="p">}</span>
         <span class="p">)</span>
       <span class="p">)</span>

     <span class="nc">JsonbMacroExample</span><span class="o">.</span><span class="n">do_combine</span><span class="p">(</span><span class="n">frag</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">conjunction</span><span class="p">)</span>
   <span class="k">end</span><span class="p">)</span>
 <span class="k">end</span>

 <span class="na">@doc</span> <span class="no">false</span>
 <span class="kd">def</span> <span class="n">do_combine</span><span class="p">(</span><span class="n">frag</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">conjunction</span><span class="p">)</span>
 <span class="kd">def</span> <span class="n">do_combine</span><span class="p">(</span><span class="n">frag</span><span class="p">,</span> <span class="no">nil</span><span class="p">,</span> <span class="bp">_</span><span class="p">),</span> <span class="ss">do</span><span class="p">:</span> <span class="n">frag</span>
 <span class="kd">def</span> <span class="n">do_combine</span><span class="p">(</span><span class="n">frag</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="ss">:or</span><span class="p">),</span> <span class="ss">do</span><span class="p">:</span> <span class="n">dynamic</span><span class="p">([</span><span class="n">q</span><span class="p">],</span> <span class="o">^</span><span class="n">acc</span> <span class="ow">or</span> <span class="o">^</span><span class="n">frag</span><span class="p">)</span>
 <span class="kd">def</span> <span class="n">do_combine</span><span class="p">(</span><span class="n">frag</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="bp">_</span><span class="p">),</span> <span class="ss">do</span><span class="p">:</span> <span class="n">dynamic</span><span class="p">([</span><span class="n">q</span><span class="p">],</span> <span class="o">^</span><span class="n">acc</span> <span class="ow">and</span> <span class="o">^</span><span class="n">frag</span><span class="p">)</span>
</code></pre></div>


<p>Now each fragment is built and combined by the <code>build_expressions/3</code> function, and we just need to call this function using the fully qualified name. </p>
<p>Second, let's expand <code>build_expressions/3</code> to allow a custom query expression (a custom fragment) for each <code>jsonb</code> column:</p>
<div class="highlight"><pre><span></span><code> <span class="na">@doc</span> <span class="no">false</span>
 <span class="na">@spec</span> <span class="n">build_expressions</span><span class="p">(</span><span class="n">map</span><span class="p">()</span> <span class="o">|</span> <span class="nc">Keyword</span><span class="o">.</span><span class="n">t</span><span class="p">(),</span> <span class="n">atom</span><span class="p">(),</span> <span class="n">atom</span><span class="p">(),</span> <span class="n">fun</span><span class="p">())</span> 
  <span class="o">::</span> <span class="nc">Macro</span><span class="o">.</span><span class="n">t</span><span class="p">()</span>
 <span class="kd">def</span> <span class="n">build_expressions</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">conjunction</span><span class="p">,</span> <span class="n">dynamic_fun</span> <span class="p">\\</span> <span class="no">nil</span><span class="p">)</span>

 <span class="kd">def</span> <span class="n">build_expressions</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">conjunction</span><span class="p">,</span> <span class="n">dynamic_fun</span><span class="p">)</span> <span class="k">do</span>
   <span class="nc">Enum</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="no">nil</span><span class="p">,</span> <span class="k">fn</span> <span class="p">{</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">},</span> <span class="n">acc</span> <span class="o">-&gt;</span>
     <span class="n">frag</span> <span class="o">=</span> <span class="nc">JsonbMacroExample</span><span class="o">.</span><span class="n">build_fragment</span><span class="p">(</span>
       <span class="n">col</span><span class="p">,</span> <span class="n">to_string</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">val</span><span class="p">,</span> <span class="n">dynamic_fun</span>
     <span class="p">)</span>

     <span class="nc">JsonbMacroExample</span><span class="o">.</span><span class="n">do_combine</span><span class="p">(</span><span class="n">frag</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">conjunction</span><span class="p">)</span>
   <span class="k">end</span><span class="p">)</span>
 <span class="k">end</span>

 <span class="na">@doc</span> <span class="no">false</span>
 <span class="na">@spec</span> <span class="n">build_fragment</span><span class="p">(</span><span class="n">binary</span><span class="p">(),</span> <span class="n">atom</span> <span class="o">|</span> <span class="n">binary</span><span class="p">(),</span> <span class="n">term</span><span class="p">(),</span> <span class="n">fun</span><span class="p">())</span> <span class="o">::</span> <span class="nc">Macro</span><span class="o">.</span><span class="n">t</span><span class="p">()</span>
 <span class="kd">def</span> <span class="n">build_fragment</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="no">nil</span><span class="p">)</span> <span class="k">do</span>
   <span class="c1"># build default dynamic fragment</span>
   <span class="n">dynamic</span><span class="p">(</span>
     <span class="p">[</span><span class="n">q</span><span class="p">],</span>
     <span class="n">fragment</span><span class="p">(</span>
       <span class="s2">&quot;?::jsonb @&gt; ?::jsonb&quot;</span><span class="p">,</span>
       <span class="n">field</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="o">^</span><span class="n">col</span><span class="p">),</span>
       <span class="o">^</span><span class="p">%{</span><span class="n">key</span> <span class="o">=&gt;</span> <span class="n">val</span><span class="p">}</span>
     <span class="p">)</span>
   <span class="p">)</span>
 <span class="k">end</span>

 <span class="kd">def</span> <span class="n">build_fragment</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">dynamic_fun</span><span class="p">)</span> <span class="k">do</span>
   <span class="n">result</span> <span class="o">=</span> <span class="n">dynamic_fun</span><span class="o">.</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
   <span class="k">case</span> <span class="n">result</span> <span class="k">do</span>
     <span class="no">nil</span> <span class="o">-&gt;</span>
       <span class="n">build_fragment</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="no">nil</span><span class="p">)</span>

     <span class="bp">_</span> <span class="o">-&gt;</span>
       <span class="n">result</span>
   <span class="k">end</span>
 <span class="k">end</span>
</code></pre></div>


<p>We added a new parameter to <code>build_expressions/4</code> called <code>dynamic_fun</code>. This is an <strong>optional</strong> function that must return an Ecto's <code>dynamic</code> expression. When <code>dynamic_fun</code> option is <code>nil</code> or returns <code>nil</code> for a given <code>jsonb</code> field, a default expression using the <code>jsonb</code> containment operator would be placed instead.</p>
<p>Let's get back to the query. We wanted vehicles which <code>passenger_capacity</code> is <strong>greater or equal than</strong> <code>x</code>, <code>engine_type</code> is <code>e_type</code>, and <code>drive_type</code> is <code>d_type</code>. We can a create custom expression to query only those vehicles which minimum capacity is greater or equal than <code>x</code>. Let's write the expression and modify our <code>query_specs/3</code> function as follows:</p>
<div class="highlight"><pre><span></span><code> <span class="c1"># vehicle&#39;s capacity is greater or equal than `val`</span>
 <span class="kd">def</span> <span class="n">query_json_col</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s2">&quot;passenger_capacity&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="k">do</span>
   <span class="n">dynamic</span><span class="p">([</span><span class="n">q</span><span class="p">],</span> <span class="n">fragment</span><span class="p">(</span>
     <span class="s2">&quot;(?::jsonb -&gt;&gt; &#39;passenger_capacity&#39;)::int &gt;= ?&quot;</span><span class="p">,</span> 
     <span class="n">field</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="o">^</span><span class="n">col</span><span class="p">),</span> 
     <span class="o">^</span><span class="n">val</span><span class="p">)</span>
   <span class="p">)</span>
 <span class="k">end</span>

 <span class="c1"># return nil for any other jsonb field</span>
 <span class="kd">def</span> <span class="n">query_json_col</span><span class="p">(</span><span class="bp">_</span><span class="p">,</span> <span class="bp">_</span><span class="p">,</span> <span class="bp">_</span><span class="p">),</span> <span class="ss">do</span><span class="p">:</span> <span class="no">nil</span>

 <span class="na">@spec</span> <span class="n">query_specs</span><span class="p">(</span><span class="nc">Ecto.Query</span><span class="o">.</span><span class="n">t</span><span class="p">(),</span> <span class="nc">Keyword</span><span class="o">.</span><span class="n">t</span><span class="p">())</span> <span class="o">::</span> <span class="p">[</span><span class="n">vehicle</span><span class="p">]</span>
 <span class="kd">def</span> <span class="n">query_specs</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">conjunction</span> <span class="p">\\</span> <span class="ss">:and</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">fragments</span> <span class="o">=</span>
        <span class="n">json_multi_expressions_v2</span><span class="p">(</span><span class="ss">:specs</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
            <span class="ss">conjunction</span><span class="p">:</span> <span class="n">conjunction</span><span class="p">,</span>
            <span class="ss">dynamic_fun</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">query_json_col</span><span class="o">/</span><span class="mi">3</span>
        <span class="p">)</span>

    <span class="n">query</span>
    <span class="o">|&gt;</span> <span class="n">where</span><span class="p">([</span><span class="n">_q</span><span class="p">],</span> <span class="o">^</span><span class="n">fragments</span><span class="p">)</span>
 <span class="k">end</span>
</code></pre></div>


<p>Using pattern matching, we created a custom expression for <code>passenger_capacity</code>. This is particularly useful for <code>jsonb</code> fields that require a bit more sophisticated expressions. For example, if we have a Vehicle's spec called <code>heated_seats</code> that usually only high-end cars include, we would check for this spec in the following way:</p>
<ul>
<li>A vehicle has heated seats when the value of <code>heated_seats</code> is <code>true</code>: </li>
</ul>
<div class="highlight"><pre><span></span><code> <span class="n">specs</span> <span class="o">@&gt;</span> <span class="s1">&#39;{&quot;heated_seats&quot;: true}&#39;</span>
</code></pre></div>


<ul>
<li>A vehicle doesn't have heated seats when the value is false, null or the field doesn't exist:</li>
</ul>
<div class="highlight"><pre><span></span><code> <span class="p">(</span><span class="n">specs</span> <span class="o">@&gt;</span> <span class="s1">&#39;{&quot;heated_seats&quot;: false}&#39;</span><span class="p">)</span> <span class="k">OR</span>
 <span class="p">(</span><span class="n">specs</span> <span class="o">@&gt;</span> <span class="s1">&#39;{&quot;heated_seats&quot;: null}&#39;</span><span class="p">)</span> <span class="k">OR</span> 
 <span class="k">NOT</span> <span class="p">(</span><span class="n">specs</span> <span class="o">?</span> <span class="s1">&#39;heated_seats&#39;</span><span class="p">)</span>
</code></pre></div>


<p>We could write this in Elixir as follows:</p>
<div class="highlight"><pre><span></span><code> <span class="c1"># no heated_seats means false, nil o inexistent `heated_seats` field</span>
 <span class="kd">def</span> <span class="n">query_json_col</span><span class="p">(</span><span class="ss">:specs</span><span class="p">,</span> <span class="s2">&quot;heated_seats&quot;</span><span class="p">,</span> <span class="no">false</span><span class="p">)</span> <span class="k">do</span>
   <span class="n">dynamic</span><span class="p">(</span>
     <span class="p">[</span><span class="n">q</span><span class="p">],</span>
     <span class="n">fragment</span><span class="p">(</span>
       <span class="s2">&quot;(specs @&gt; ?::jsonb OR specs @&gt; ?::jsonb OR NOT (specs \\? ?)&quot;</span><span class="p">,</span>
       <span class="p">%{</span><span class="s2">&quot;heated_seats&quot;</span> <span class="o">=&gt;</span> <span class="no">false</span><span class="p">},</span>
       <span class="p">%{</span><span class="s2">&quot;heated_seats&quot;</span> <span class="o">=&gt;</span> <span class="no">nil</span><span class="p">}</span>
       <span class="s2">&quot;heated_seats&quot;</span><span class="p">,</span>
     <span class="p">)</span>
   <span class="p">)</span>
 <span class="k">end</span>

 <span class="kd">def</span> <span class="n">query_json_col</span><span class="p">(</span><span class="bp">_</span><span class="p">,</span> <span class="bp">_</span><span class="p">,</span> <span class="bp">_</span><span class="p">),</span> <span class="ss">do</span><span class="p">:</span> <span class="no">nil</span>
</code></pre></div>


<p>Without changing anything at <code>query_specs/3</code>, we can now query for vehicles which <code>passenger_capacity</code> is <strong>greater or equal than</strong> <code>x</code>, <code>engine_type</code> is <code>e_type</code>, <code>drive_type</code> is <code>d_type</code> and <code>heated_seats</code> are <code>a_boolean</code>.</p>
<div class="highlight"><pre><span></span><code> <span class="n">iex</span><span class="o">&gt;</span> <span class="n">query_specs</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">%{</span>
   <span class="ss">engine_type</span><span class="p">:</span> <span class="s2">&quot;Electric&quot;</span><span class="p">,</span> 
   <span class="ss">passenger_capacity</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> 
   <span class="ss">drive_type</span><span class="p">:</span> <span class="s2">&quot;Front Wheel&quot;</span><span class="p">,</span>
   <span class="ss">heated_seats</span><span class="p">:</span> <span class="no">false</span>
 <span class="p">})</span> <span class="o">|&gt;</span> <span class="nc">Repo</span><span class="o">.</span><span class="n">all</span>
 <span class="p">[</span>
   <span class="p">%</span><span class="nc">JsonbMacroExample.Schemas.Vehicle</span><span class="p">{</span>
     <span class="ss">__meta__</span><span class="p">:</span> <span class="c1">#Ecto.Schema.Metadata&lt;:loaded, &quot;vehicle&quot;&gt;,</span>
     <span class="ss">brand</span><span class="p">:</span> <span class="s2">&quot;Mercedes-Benz&quot;</span><span class="p">,</span>
     <span class="ss">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
     <span class="ss">model</span><span class="p">:</span> <span class="s2">&quot;E Class&quot;</span><span class="p">,</span>
     <span class="ss">specs</span><span class="p">:</span> <span class="p">%{</span>
       <span class="s2">&quot;passenger_capacity&quot;</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">,</span>
       <span class="s2">&quot;engine_type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Electric&quot;</span><span class="p">,</span>
       <span class="s2">&quot;drive_type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Front Wheel&quot;</span>
     <span class="p">}</span>
   <span class="p">}</span>
   <span class="n">...</span>
 <span class="p">]</span>
</code></pre></div>


<p>Similarly, because <code>query_specs/3</code> is composable, we pipe the function after other queries:</p>
<div class="highlight"><pre><span></span><code> <span class="kd">def</span> <span class="n">family_electric_mercedes</span> <span class="k">do</span>
   <span class="nc">Vehicle</span>
   <span class="o">|&gt;</span> <span class="n">where</span><span class="p">([</span><span class="n">v</span><span class="p">],</span> <span class="n">v</span><span class="o">.</span><span class="n">brand</span> <span class="o">==</span> <span class="o">^</span><span class="n">brand</span><span class="p">)</span>
   <span class="o">|&gt;</span> <span class="n">query_specs</span><span class="p">(%{</span>
     <span class="ss">passenger_capacity</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> 
     <span class="ss">passenger_doors</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> 
     <span class="ss">engine_type</span><span class="p">:</span> <span class="s2">&quot;Electric&quot;</span>
   <span class="p">})</span>
 <span class="k">end</span>
</code></pre></div>


<h2>The final macro</h2>
<p>We now have a general purpose macro to query <code>jsonb</code> columns as required:</p>
<div class="highlight"><pre><span></span><code> <span class="na">@doc</span> <span class="sh">&quot;&quot;&quot;</span>
<span class="sh"> A macro that generates multiple fragments using dynamic expressions.</span>

<span class="sh"> Options</span>

<span class="sh">   * `conjunction`: define whether to use `and` or `or` to join dynamic </span>
<span class="sh">   expressions for each parameter. By default uses `and`.</span>
<span class="sh">   * `gen_dynamic` - An optional function to generate a dynamic fragment</span>
<span class="sh">   (using `Ecto.Query.dynamic`).</span>
<span class="sh"> &quot;&quot;&quot;</span>
 <span class="kd">defmacro</span> <span class="n">json_multi_expressions</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span> <span class="k">do</span>
   <span class="c1"># conjuctive operator to be used between fragments</span>
   <span class="n">conjunction</span> <span class="o">=</span> <span class="nc">Keyword</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="ss">:conjunction</span><span class="p">,</span> <span class="ss">:and</span><span class="p">)</span>
   <span class="c1"># a function that generates a dynamic expression</span>
   <span class="n">dynamic_fun</span> <span class="o">=</span> <span class="nc">Keyword</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="ss">:dynamic_fun</span><span class="p">)</span>

   <span class="k">quote</span> <span class="k">do</span>
     <span class="nc">JsonbMacroExample</span><span class="o">.</span><span class="n">build_expressions</span><span class="p">(</span>
       <span class="k">unquote</span><span class="p">(</span><span class="n">params</span><span class="p">),</span>
       <span class="k">unquote</span><span class="p">(</span><span class="n">col</span><span class="p">),</span>
       <span class="k">unquote</span><span class="p">(</span><span class="n">conjunction</span><span class="p">),</span>
       <span class="k">unquote</span><span class="p">(</span><span class="n">dynamic_fun</span><span class="p">)</span>
     <span class="p">)</span>
   <span class="k">end</span>
 <span class="k">end</span>

 <span class="na">@doc</span> <span class="no">false</span>
 <span class="na">@spec</span> <span class="n">build_expressions</span><span class="p">(</span><span class="n">map</span><span class="p">()</span> <span class="o">|</span> <span class="nc">Keyword</span><span class="o">.</span><span class="n">t</span><span class="p">(),</span> <span class="n">atom</span><span class="p">(),</span> <span class="n">atom</span><span class="p">(),</span> <span class="n">fun</span><span class="p">())</span> 
   <span class="o">::</span> <span class="nc">Macro</span><span class="o">.</span><span class="n">t</span><span class="p">()</span>
 <span class="kd">def</span> <span class="n">build_expressions</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">conjunction</span><span class="p">,</span> <span class="n">dynamic_fun</span> <span class="p">\\</span> <span class="no">nil</span><span class="p">)</span>

 <span class="kd">def</span> <span class="n">build_expressions</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">conjunction</span><span class="p">,</span> <span class="n">dynamic_fun</span><span class="p">)</span> <span class="k">do</span>
   <span class="nc">Enum</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="no">nil</span><span class="p">,</span> <span class="k">fn</span> <span class="p">{</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">},</span> <span class="n">acc</span> <span class="o">-&gt;</span>
     <span class="n">frag</span> <span class="o">=</span> <span class="nc">JsonbMacroExample</span><span class="o">.</span><span class="n">build_fragment</span><span class="p">(</span>
       <span class="n">col</span><span class="p">,</span> 
       <span class="n">to_string</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> 
       <span class="n">val</span><span class="p">,</span> 
       <span class="n">dynamic_fun</span>
     <span class="p">)</span>

     <span class="c1"># TODO I&#39;d write this using a case, but it generates a compilation warning</span>
     <span class="c1"># https://github.com/elixir-lang/elixir/issues/6738</span>
     <span class="nc">JsonbMacroExample</span><span class="o">.</span><span class="n">do_combine</span><span class="p">(</span><span class="n">frag</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">conjunction</span><span class="p">)</span>
   <span class="k">end</span><span class="p">)</span>
 <span class="k">end</span>

 <span class="na">@doc</span> <span class="no">false</span>
 <span class="na">@spec</span> <span class="n">build_fragment</span><span class="p">(</span><span class="n">binary</span><span class="p">(),</span> <span class="n">atom</span> <span class="o">|</span> <span class="n">binary</span><span class="p">(),</span> <span class="n">term</span><span class="p">(),</span> <span class="n">fun</span><span class="p">())</span> <span class="o">::</span> <span class="nc">Macro</span><span class="o">.</span><span class="n">t</span><span class="p">()</span>
 <span class="kd">def</span> <span class="n">build_fragment</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="no">nil</span><span class="p">)</span> <span class="k">do</span>
   <span class="c1"># build default dynamic fragment</span>
   <span class="n">dynamic</span><span class="p">(</span>
     <span class="p">[</span><span class="n">q</span><span class="p">],</span>
     <span class="n">fragment</span><span class="p">(</span>
       <span class="s2">&quot;?::jsonb @&gt; ?::jsonb&quot;</span><span class="p">,</span>
       <span class="n">field</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="o">^</span><span class="n">col</span><span class="p">),</span>
       <span class="o">^</span><span class="p">%{</span><span class="n">key</span> <span class="o">=&gt;</span> <span class="n">val</span><span class="p">}</span>
     <span class="p">)</span>
   <span class="p">)</span>
 <span class="k">end</span>

 <span class="kd">def</span> <span class="n">build_fragment</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">dynamic_fun</span><span class="p">)</span> <span class="k">do</span>
   <span class="n">result</span> <span class="o">=</span> <span class="n">dynamic_fun</span><span class="o">.</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

   <span class="k">case</span> <span class="n">result</span> <span class="k">do</span>
     <span class="no">nil</span> <span class="o">-&gt;</span>
       <span class="n">build_fragment</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="no">nil</span><span class="p">)</span>

     <span class="bp">_</span> <span class="o">-&gt;</span>
       <span class="n">result</span>
   <span class="k">end</span>
 <span class="k">end</span>

 <span class="na">@doc</span> <span class="no">false</span>
 <span class="kd">def</span> <span class="n">do_combine</span><span class="p">(</span><span class="n">frag</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">conjunction</span><span class="p">)</span>
 <span class="kd">def</span> <span class="n">do_combine</span><span class="p">(</span><span class="n">frag</span><span class="p">,</span> <span class="no">nil</span><span class="p">,</span> <span class="bp">_</span><span class="p">),</span> <span class="ss">do</span><span class="p">:</span> <span class="n">frag</span>
 <span class="kd">def</span> <span class="n">do_combine</span><span class="p">(</span><span class="n">frag</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="ss">:or</span><span class="p">),</span> <span class="ss">do</span><span class="p">:</span> <span class="n">dynamic</span><span class="p">([</span><span class="n">q</span><span class="p">],</span> <span class="o">^</span><span class="n">acc</span> <span class="ow">or</span> <span class="o">^</span><span class="n">frag</span><span class="p">)</span>
 <span class="kd">def</span> <span class="n">do_combine</span><span class="p">(</span><span class="n">frag</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="bp">_</span><span class="p">),</span> <span class="ss">do</span><span class="p">:</span> <span class="n">dynamic</span><span class="p">([</span><span class="n">q</span><span class="p">],</span> <span class="o">^</span><span class="n">acc</span> <span class="ow">and</span> <span class="o">^</span><span class="n">frag</span><span class="p">)</span>
</code></pre></div>


<h2>Notes &amp; References</h2>
<ul>
<li>The source code could be found in <a href="https://github.com/jsangilve/ecto_jsonb_macro_example" target="&quot;_blank">GitHub</a></li>
</ul>
<p>Some related articles and PostgreSQL docs about <code>jsonb</code>:</p>
<ul>
<li><a href="https://robots.thoughtbot.com/querying-embedded-maps-in-postgresql-with-ecto" target="&quot;_blank">Querying an Embedded Map...</a></li>
<li><a href="http://www.ubazu.com/using-postgres-jsonb-columns-in-ecto" target="&quot;_blank">Using PostgreSQL Jsonb columns in Ecto</a></li>
<li><a href="https://www.postgresql.org/docs/9.4/datatype-json.html" target="&quot;_blank">JSON Types</a></li>
<li><a href="https://www.postgresql.org/docs/9.4/datatype-json.html" target="&quot;_blank">JSON Functions and Operators</a></li>
</ul>
  </div><!-- /.entry-content -->
</section>
                  <!-- /#contentinfo -->
                  </div>
            </div>

            <footer id="contentinfo">
              <div class="container">
                <span>José San Gil / <a href="https://twitter.com/jsangilve">@jsangilve</a></a><span class="credit">logo by AVA ROWELL from the Noun Project</span>
              </div>
            </footer>
            <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-11146701-2', 'auto');
              ga('send', 'pageview');
            </script>
  </body>
</html>